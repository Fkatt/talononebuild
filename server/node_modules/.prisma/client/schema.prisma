// TalonForge Database Schema
// Prisma ORM for type-safe database access

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Authentication and authorization
model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  role         String   @default("Admin")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  instances Instance[]

  @@map("users")
}

// Instance model - Talon.One or Contentful instances
model Instance {
  id                   Int      @id @default(autoincrement())
  name                 String
  type                 String // 'talon' or 'contentful'
  region               String
  url                  String
  encryptedCredentials String   @db.Text // Stores IV:ciphertext format
  bundleId             String? // For grouping instances into "Gigastores"
  vertical             String? // Industry vertical
  status               String   @default("online") // 'online', 'offline', 'error'
  userId               Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bundleId])
  @@map("instances")
}

// SystemSettings model - Application-wide configuration
model SystemSettings {
  id         Int      @id @default(autoincrement())
  aiProvider String   @default("openai") // AI provider name
  aiConfig   Json // JSON configuration for AI (API keys, models, etc.)
  docLinks   Json // JSON object with documentation links
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("system_settings")
}

// Backup model - Stores backup metadata
model Backup {
  id         Int      @id @default(autoincrement())
  name       String
  instanceId Int // Reference to the instance that was backed up
  data       Json     @db.JsonB // The actual backup data
  size       Int      @default(0) // Size of backup data in bytes
  vertical   String? // Industry vertical for filtering
  createdAt  DateTime @default(now())

  @@index([instanceId])
  @@index([vertical])
  @@map("backups")
}

// MigrationLog model - Track migration history
model MigrationLog {
  id          Int       @id @default(autoincrement())
  sourceId    Int // Source instance ID
  destId      Int // Destination instance ID
  assets      Json // Array of assets migrated
  status      String // 'success', 'failed', 'partial'
  errors      Json? // Error details if any
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([sourceId])
  @@index([destId])
  @@index([status])
  @@map("migration_logs")
}

// AIFeedback model - Track AI generation feedback for tuning
model AIFeedback {
  id        Int      @id @default(autoincrement())
  prompt    String   @db.Text
  response  Json     @db.JsonB
  rating    Int // 1-5 rating
  feedback  String?  @db.Text
  createdAt DateTime @default(now())

  @@map("ai_feedback")
}

// Vertical model - Custom industry verticals
model Vertical {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("verticals")
}
